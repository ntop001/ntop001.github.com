---
layout: post
title: "Ajax"
description: ""
category: "知识整理"
tags: [web]
---
{% include JB/setup %}

有两本书让我对网页和Web服务器更加了解，一本是 《HeadFirst Ajax》 一本是谢孟军写的 [《Go Web 编程》](https://github.com/astaxie/build-web-application-with-golang)
前者主要讲解了现在的(因为过去的网页都是每次请求重新加载整个页面)网页是如何和服务器交互的，这种交互方式就叫Ajax。后者主要讲解了服务器
的逻辑，一个Web服务是如何处理网页请求的。

Ajax其实是一种网页设计的理念，过去的网页每次刷新都要重新加载整个网页，网页加载过程中无法继续操作页面，而网页加载过程又很慢，整个
用户体验很差。Ajax 通过javascript脚本(以后简称js)异步的请求网页中需要更新的部分，然后局部的刷新网页。这种至少有两个优点

1. 网页值加载需要的部分占用带宽少
2. 请求过程异步，不会影响用户体验

下面通过文件上传来解释Ajax过程，先从过去表单(Form)请求开始

## 过去的表单请求

表单用于向服务器传输数据，所有的浏览器都支持，表单大概张成这样 

```
<form action="/upload" enctype="multipart/form-data" method="post">
    <input type="file" name="upload" multiple="multiple"/>
    <input type="submit" value="Upload file" />
</form>
```

最外层是一个 `<form />` 标签，里面可以嵌入一些 `<input />` 标签，`<input/>` 标签可以设置多种不同的类型比如 

1. type="text" 设置类型为文本输入框
2. type="file" 设置类型为文件上传按钮
3. type="submit" 设置类型为提交按钮

`<input/>` 标签可以设置各种类型，见w3c的[教程](http://www.w3school.com.cn/tags/tag_input.asp),点击提交按钮后，
会把其他input标签的内容同步提交给服务器，其实就是一个post请求，注意到 `<input type="text" name="fname" />` 每个input都有一个
`name` 属性，服务器可以通过它区分不同字段的值。

## Ajax 请求

Ajax 请求分成两部分，一部分是网页提供一个表单用来选择需要上传的文件，一部分是js用来上传文件

```
<form id="apk_form" enctype="multipart/form-data" method="post" action="upload">
    <input type="file" name="upload" id="fileToUpload"/>
</form>
```
注意没有 `submit` 类型的按钮，但是我们会用js监测文件选择按钮，等文件ready之后，就直接用js提交到服务器 

```
//在网页加载的时候找到选择文件的按钮
var fileUploader = document.getElementById('fileToUpload')
//监测事件
fileUploader.onchange = function(){
//上传选择的第一个文件
  var file = fileUploader.files[0];
  if (file) {
      //new一个form对象
      var fd = new FormData();
      fd.append("upload", file);
      //new一个XMLHttpRequest请求
      var xhr = new XMLHttpRequest();
      xhr.addEventListener("load", function(evt){
        alert("上传成功:" + evt.target.responseText)
      }, false);
      xhr.addEventListener("error", function(evt){
        alert("上传失败")
      }, false);
      xhr.open("POST", "url to server");
      xhr.send(fd);
  }
}
```

## 准备工作

一般不会把大片的js代码嵌入到HTML页面(`<script/>`标签) 这样会使HTML文件太大且比较复杂，大多时候是把js代码单独写到一个文件中，然后使用在HTML页面中加载js代码，比如 index.html

```
<!DOCTYPE html>

<html>
  	<head>
    	<title>Beego</title>
    	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <script type="text/javascript" src="static/js/main.js"></script>
	</head>
  	
  	<body>
      ...
	</body>
</html>
```

这样在加载HTML网页(有一种更好的方法是把js文件放到HTML页面的末尾)的时候会自动下载 `main.js` 这个文件，我们会在这个文件中写一些js代码，比如

```
window.onload = initPage;
function initPage() {
// do somethign
}
```
这样在页面加载的时候会执行 `initPage` 方法，可以在这里面执行一些初始化的事情。

## Ajax 请求

像上面那样直接书写 `var xhr = new XMLHttpRequest();` 在一些浏览器上可能会无法工作，要考虑所有浏览器的情况就要多做一些工作,专门创建一个函数用来
创建一个http请求,这个函数会考虑各种浏览器的兼容问题。下面详细的演示Ajax请求一个图片。

```
function createRequest() {
    try {
        request = new XMLHttpRequest();
        } catch (tryMS) {
            try {
                request = new ActiveXObject("Msxml2.XMLHTTP");
            } catch (otherMS) {
                try {
                    request = new ActiveXObject("Microsoft.XMLHTTP");
                } catch (failed) {
                    request = null;
                }
            }
        }
    return request;
}
```

`XMLHttpRequest` 是大部分浏览器支持的请求，后面的两个 `ActiveXObject` 是微软特定的 http 请求(所以知道为啥大家痛恨IE了吗？)

```
function getDetails(url) {
    request = createRequest();
    if (request==null) {
        alert("Unable to create request");
        return;
    }
    request.open("GET",url,true);
    request.onreadystatechange = displayDetails;
    request.send(null);
}

function displayDetails() {
    if (request.readyState == 4) {
        if (request.status == 200) {
            //更新页面
            //detailDiv = document.getElementById("description");
            //detailDiv.innerHTML = request.responseText;
        }
    }
}
```
`request.open` 有三个参数

1. string 设置请求类型 `GET`、 `POST`等等
2. string 设置请求的URL
3. bool true 发起异步请求 false 发起同步请求

`request.onreadystatechange` 设置请求结束之后的回调函数, `request.send(null)` 可以用这个函数发送一些额外的表单数据，如果没有
可以直接填 `null`, 发送表单数据在前面有演示过。

`request` 对象拥有几个属性可以用来获取服务器返回的信息

1. readyState 0 是初始化的值 1 服务器响应请求 2、3 服务器在处理数据 4 服务返回
2. status HTTP协议中的状态码 200 OK
3. responseXML 服务器数据用xml格式返回的时候
4. responseText 服务器用文本格式返回数据的时候




